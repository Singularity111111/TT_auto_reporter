import time
import os
from datetime import date
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait, Select
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
# â­ æ–°å¢å¼ºå¤§çš„æ•°æ®å¤„ç†åº“
import pandas as pd

# ===============================================
#                 â­â­â­ é…ç½®åŒº â­â­â­
# ===============================================

# 1. ç›®æ ‡ç½‘ç«™åå°ç™»å½•ä¿¡æ¯
LOGIN_URL = "https://admin.sgo79z11raz9mx1v.1xspin.games/session/new"
USERNAME = "touhou01"
PASSWORD = "518ad6eba0b353e7"

# 2. æ•°æ®æ–‡ä»¶ä¿å­˜çš„è·¯å¾„
#    é»˜è®¤ä¼šä¿å­˜åœ¨æ‚¨æ¡Œé¢ä¸Šçš„ "1xspin_reports" æ–‡ä»¶å¤¹ä¸­
SAVE_PATH = os.path.join(os.path.expanduser('~'), 'Desktop', '1xspin_reports')


# ===============================================

def scrape_and_save_table(driver, report_name, save_path):
    """
    åœ¨å½“å‰é¡µé¢ä¸ŠæŸ¥æ‰¾HTMLè¡¨æ ¼ï¼Œè¯»å–å…¶å†…å®¹ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸ºCSVæ–‡ä»¶ã€‚
    """
    try:
        print(f"  ğŸ¤– æ­£åœ¨é¡µé¢ä¸ŠæŸ¥æ‰¾æ•°æ®è¡¨æ ¼...")
        wait = WebDriverWait(driver, 15)
        table_element = wait.until(EC.presence_of_element_located((By.TAG_NAME, "table")))

        html_content = table_element.get_attribute('outerHTML')
        # ä½¿ç”¨ lxml è§£æå™¨è¯»å–è¡¨æ ¼
        df_list = pd.read_html(html_content, flavor='lxml')

        if not df_list:
            print(f"  [âŒ é”™è¯¯] åœ¨ '{report_name}' é¡µé¢ä¸Šæœªæ‰¾åˆ°ä»»ä½•è¡¨æ ¼ï¼")
            return

        df = df_list[0]

        if not os.path.exists(save_path):
            os.makedirs(save_path)

        today_str = date.today().strftime('%Y-%m-%d')
        filename = f"1xspin_{report_name}_{today_str}.csv"
        filepath = os.path.join(save_path, filename)

        df.to_csv(filepath, index=False, encoding='utf-8-sig')

        print(f"  [âœ… æˆåŠŸ] æ•°æ®å·²æŠ“å–å¹¶ä¿å­˜ä¸º: {filename}")
        return True  # è¿”å›æˆåŠŸæ ‡å¿—

    except Exception as e:
        print(f"  [âŒ é”™è¯¯] åœ¨æŠ“å– '{report_name}' è¡¨æ ¼æ—¶å‘ç”Ÿé”™è¯¯: {e}")
        return False  # è¿”å›å¤±è´¥æ ‡å¿—


# --- ä¸»ç¨‹åºå¼€å§‹ ---
print("--- 1xspin åå°ç•™å­˜æ•°æ®çˆ¬è™« (v3.3 ä¿®å¤ä¾èµ–å¹¶å¢åŠ åˆ†é¡µå¤„ç†) ---")

# é…ç½®æµè§ˆå™¨é€‰é¡¹
chrome_options = Options()
chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
chrome_options.add_experimental_option('useAutomationExtension', False)
chrome_options.add_argument(
    'user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36')
chrome_options.add_argument('--disable-blink-features=AutomationControlled')

driver = None  # åˆå§‹åŒ–driverå˜é‡
try:
    print("\n[åˆå§‹åŒ–] æ­£åœ¨è‡ªåŠ¨æ£€æµ‹Chromeç‰ˆæœ¬å¹¶ä¸‹è½½åŒ¹é…çš„é©±åŠ¨...")
    s = Service(ChromeDriverManager().install())
    driver = webdriver.Chrome(service=s, options=chrome_options)
    print("[âœ… é©±åŠ¨å‡†å¤‡å°±ç»ª!]")

    wait = WebDriverWait(driver, 20)

    # 1. ç™»å½•
    print(f"\n[æ­¥éª¤ 1/3] æ­£åœ¨æ‰“å¼€ç™»å½•é¡µé¢: {LOGIN_URL}")
    driver.get(LOGIN_URL)

    print("  > æ­£åœ¨è¾“å…¥è´¦å·...")
    wait.until(EC.presence_of_element_located((By.ID, "email_address"))).send_keys(USERNAME)

    print("  > æ­£åœ¨è¾“å…¥å¯†ç ...")
    driver.find_element(By.ID, "password").send_keys(PASSWORD)

    print("  > æ­£åœ¨ç‚¹å‡»ç™»å½•æŒ‰é’®...")
    driver.find_element(By.XPATH, "//button[@type='submit']").click()

    print("  > ç­‰å¾…ç™»å½•æˆåŠŸ...")
    wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, "a[href='/data_report/user_retentions']")))
    print("[âœ… ç™»å½•æˆåŠŸ!]")

    reports_to_scrape = [
        {"name": "é¦–å……ç™»å½•ç•™å­˜", "tab_selector": (By.CSS_SELECTOR, "a[href*='user_type=first_login_user']")},
        {"name": "é¦–å……ä¸‹æ³¨ç•™å­˜", "tab_selector": (By.CSS_SELECTOR, "a[href*='user_type=first_play_user']")},
        {"name": "é¦–å……ä»˜è´¹ç•™å­˜", "tab_selector": (By.CSS_SELECTOR, "a[href*='user_type=first_pay_user']")}
    ]

    print(f"\n[æ­¥éª¤ 2/3] å‡†å¤‡å¼€å§‹æŠ“å– {len(reports_to_scrape)} ä»½ç•™å­˜æŠ¥è¡¨...")

    retention_url = "https://admin.sgo79z11raz9mx1v.1xspin.games/data_report/user_retentions"
    print(f"  > æ­£åœ¨è·³è½¬åˆ°ç”¨æˆ·ç•™å­˜ä¸»é¡µé¢...")
    driver.get(retention_url)

    success_count = 0
    for report in reports_to_scrape:
        report_name = report['name']
        print(f"\n--- æ­£åœ¨å¤„ç†æŠ¥è¡¨: ã€Š{report_name}ã€‹ ---")

        print(f"  > æ­£åœ¨åˆ‡æ¢åˆ° '{report_name}' æ ‡ç­¾é¡µ...")
        wait.until(EC.element_to_be_clickable(report['tab_selector'])).click()

        # â­ æ–°å¢é€»è¾‘ï¼šè®¾ç½®æ¯é¡µæ˜¾ç¤ºæ¡æ•°ä¸º500 â­
        try:
            print("  > æ­£åœ¨è®¾ç½®æ¯é¡µæ˜¾ç¤º 500 æ¡æ•°æ®...")
            # 1. å®šä½åˆ°ä¸‹æ‹‰é€‰æ‹©æ¡†
            size_dropdown = Select(wait.until(EC.presence_of_element_located((By.ID, "size"))))
            # 2. é€‰æ‹©å€¼ä¸º "500" çš„é€‰é¡¹
            size_dropdown.select_by_value("500")
            print("  > ç­‰å¾…é¡µé¢åˆ·æ–°æ•°æ®...")
            time.sleep(5)  # ç­‰å¾…é¡µé¢é‡æ–°åŠ è½½è¡¨æ ¼
        except Exception as e:
            print(f"  [âš ï¸ è­¦å‘Š] è®¾ç½®æ¯é¡µæ˜¾ç¤ºæ¡æ•°å¤±è´¥: {e}ã€‚å°†å°è¯•æŠ“å–å½“å‰é¡µé¢æ•°æ®ã€‚")

        if scrape_and_save_table(driver, report_name, SAVE_PATH):
            success_count += 1

    print("\n" + "=" * 50)
    if success_count == len(reports_to_scrape):
        print("ğŸ‰ğŸ‰ğŸ‰ å…¨éƒ¨ç•™å­˜æŠ¥è¡¨æŠ“å–æˆåŠŸï¼ ğŸ‰ğŸ‰ğŸ‰")
        print(f"æ–‡ä»¶å·²å…¨éƒ¨ä¿å­˜åˆ°æ‚¨æ¡Œé¢ä¸Šçš„æ–‡ä»¶å¤¹ä¸­: {SAVE_PATH}")
    else:
        print(f"âš ï¸ éƒ¨åˆ†æŠ¥è¡¨æŠ“å–å¤±è´¥ï¼ŒæˆåŠŸ {success_count} / {len(reports_to_scrape)} ä»½ã€‚è¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯æ—¥å¿—ã€‚")
    print("=" * 50)

except Exception as e:
    print(f"\n[âŒ ä¸¥é‡é”™è¯¯] è„šæœ¬åœ¨è¿è¡Œä¸­å‘ç”Ÿæ„å¤–: {e}")
    print("è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ–ç½‘ç«™æ˜¯å¦å·²æ›´æ–°ã€‚")

finally:
    if driver:
        driver.quit()
    print("\n[æ­¥éª¤ 3/3] æµè§ˆå™¨å·²å…³é—­ï¼Œè„šæœ¬è¿è¡Œç»“æŸã€‚")

